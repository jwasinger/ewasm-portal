<!DOCTYPE html>
<html lang="en">
  <!-- Beautiful Jekyll | MIT license | Copyright Dean Attali 2016 -->
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>Solidity Memory Array Creation Overflow Bug | Ewasm</title>

  <meta name="author" content="Ewasm Team" />

  

  <link rel="alternate" type="application/rss+xml" title="Ewasm - Collection of articles about the Solidity language and compiler" href="/ewasm-portal/feed.xml" />

  

  
    
      
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />

    
  

  
    
      <link rel="stylesheet" href="/ewasm-portal/css/bootstrap.min.css" />
    
      <link rel="stylesheet" href="/ewasm-portal/css/bootstrap-social.css" />
    
      <link rel="stylesheet" href="/ewasm-portal/css/main.css" />
    
      <link rel="stylesheet" href="/ewasm-portal/css/search.css" />
    
  

  
    
      <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
    
      <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
    
  

  

  

  

    <!-- Facebook OpenGraph tags -->
  

  
  <meta property="og:title" content="Solidity Memory Array Creation Overflow Bug" />
  

   
  <meta property="og:description" content="On the 28th of March, a bug in the Solidity code generator was reported through the Ethereum Foundation Bounty program, by John Toman of Certora. The bug is fixed with version 0.6.5, released on 2020-04-06. The bug is present in all prior versions of Solidity. We assigned a severity level...">
  


  <meta property="og:type" content="website" />

  
  <meta property="og:url" content="https://ewasm.ethereum.org/2020/04/06/memory-creation-overflow-bug/" />
  <link rel="canonical" href="https://ewasm.ethereum.org/2020/04/06/memory-creation-overflow-bug/" />
  

  
  <meta property="og:image" content="/img/ewasm2d.png" />
  


  <!-- Twitter summary cards -->
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@" />
  <meta name="twitter:creator" content="@" />

  
  <meta name="twitter:title" content="Solidity Memory Array Creation Overflow Bug" />
  

  
  <meta name="twitter:description" content="On the 28th of March, a bug in the Solidity code generator was reported through the Ethereum Foundation Bounty program, by John Toman of Certora. The bug is fixed with version 0.6.5, released on 2020-04-06. The bug is present in all prior versions of Solidity. We assigned a severity level...">
  

  
  <meta name="twitter:image" content="https://ewasm.ethereum.org/favicon.png" />
  

  

  <link rel="shortcut icon" type="image/png" href="/favicon.png"/>

</head>


  <body>

    
  
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      
        <a class="navbar-brand" href="https://ewasm.ethereum.org">Ewasm</a>
      
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
      
        
          <li>
            






<a href="/ewasm-portal/blog/">Blog</a>

          </li>
        
        
        
          <li>
            






<a href="/ewasm-portal/projects/">Projects</a>

          </li>
        
        
        
          <li>
            






<a href="/ewasm-portal/publications/">Publications</a>

          </li>
        
        
        
          <li>
            






<a href="/ewasm-portal/faq/">FAQ</a>

          </li>
        
        
      </ul>
    </div>

	

  </div>
</nav>


    <!-- TODO this file has become a mess, refactor it -->



  

  <header class="header-section ">
  

  <div class="intro-header no-img">
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
          <div class="post-heading">
            <h1>Solidity Memory Array Creation Overflow Bug</h1>
            
        
            
              <span class="post-meta">Posted by Solidity Team on April 6, 2020</span>
              <ul class="post-category-list">
                
                <li>
                  <a
                    href="/ewasm-portal/category/security-alerts/"
                    class="category-security-alerts">
                    Security Alerts
                  </a>
                </li>
                
              </ul>
            
          </div>
        </div>
      </div>
    </div>
  </div>
  </header>




<div class="container">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">

      

      <article role="main" class="blog-post">
        <p>On the 28th of March, a bug in the Solidity code generator was reported through the
<a href="https://bounty.ethereum.org/">Ethereum Foundation Bounty program</a>,
by John Toman of <a href="https://www.certora.com/">Certora</a>. The bug is fixed with version 0.6.5,
released on 2020-04-06.
The bug is present in all prior versions of Solidity.</p>

<p>We assigned a severity level of “low” because we found the bug to be uncommon and at the same time hard to exploit.</p>

<h2 id="who-should-be-concerned">Who should be concerned</h2>

<p>If you have deployed a contract which allocates a memory array of user-supplied length,
but does not copy or iterate over it, this can lead to memory corruption.
In particular, a sufficiently large length during the allocation of the memory array
will result in subsequent memory allocations to overlap with the memory region of the array.
However, the length of the array is correctly stored, so copying or iterating over the array
(which is what all contracts we screened do just after the allocation)
will terminate and revert the transation with out-of-gas in these cases.</p>

<h2 id="how-to-check-if-contract-is-vulnerable">How to check if contract is vulnerable</h2>

<p>If you allocate dynamic memory arrays using <code class="language-plaintext highlighter-rouge">new T[](length)</code> with a length that depends
on user input, you may be vulnerable to this bug. If it is possible to supply a sufficiently
large length, subsequent memory allocations will have overlapping memory regions and operations
that use memory scratch space can invalidate the contents of the array.
If you traverse or copy the array after creating it, however,
the transaction will revert with out-of-gas, since the array length is stored correctly.</p>

<p>Safe example:</p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">contract</span> <span class="n">C</span> <span class="p">{</span>
        <span class="k">function</span> <span class="n">f</span><span class="p">(</span><span class="kt">uint</span> <span class="n">length</span><span class="p">)</span> <span class="k">public</span> <span class="p">{</span>
            <span class="kt">uint</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">x</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">uint</span><span class="p">[](</span><span class="n">length</span><span class="p">);</span>
            <span class="c1">// This is safe because the loop will run out of gas.
</span>            <span class="k">for</span> <span class="p">(</span><span class="kt">uint</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="o">**</span><span class="mi">2</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="p">...</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>Another safe example:</p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">contract</span> <span class="n">C</span> <span class="p">{</span>
        <span class="kt">uint</span><span class="p">[]</span> <span class="n">x</span><span class="p">;</span>
        <span class="k">function</span> <span class="n">f</span><span class="p">(</span><span class="kt">uint</span> <span class="n">length</span><span class="p">)</span> <span class="k">public</span> <span class="p">{</span>
            <span class="c1">// This is safe because the copy from memory to storage will
</span>            <span class="c1">// iterate over the whole array and go out-of-gas.
</span>            <span class="n">x</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">uint</span><span class="p">[](</span><span class="n">length</span><span class="p">);</span>
            <span class="p">...</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>Potentially vulnerable example:</p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">contract</span> <span class="n">C</span> <span class="p">{</span>
        <span class="k">function</span> <span class="n">f</span><span class="p">(</span><span class="kt">uint</span> <span class="n">length</span><span class="p">,</span> <span class="n">AnotherContract</span> <span class="n">c</span><span class="p">,</span> <span class="kt">uint</span> <span class="n">index</span><span class="p">)</span> <span class="k">public</span> <span class="p">{</span>
            <span class="kt">uint</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">x</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">uint</span><span class="p">[](</span><span class="n">length</span><span class="p">);</span>
            <span class="kt">uint</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">y</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">uint</span><span class="p">[](</span><span class="mi">4</span><span class="p">);</span>
            <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">.</span><span class="n">g</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
            <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">.</span><span class="n">g</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]);</span>
            <span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">.</span><span class="n">g</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]);</span>
            <span class="n">y</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">.</span><span class="n">g</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]);</span>
            <span class="n">c</span><span class="p">.</span><span class="n">h</span><span class="p">(</span><span class="n">y</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div></div>

<h2 id="technical-details">Technical details</h2>

<p>Solidity did not enforce an upper length limit for dynamic array allocations at runtime.
While the length of the array is stored directly as is, the amount of memory to allocate,
i.e. the increment for the “free memory pointer”, is calculated as 32 times the array length.
Since this multiplication was not protected against overflows, a sufficiently large length
can cause an overflow, resulting in only a small amount of memory to be actually allocated
(i.e. the free memory pointer will only be incremented by the overflowed size).
Subsequent memory allocations will therefore use memory regions that overlap with
the originally allocated array.
Starting from Solidity version 0.6.5 the maximum allocation size for dynamic memory arrays
is <code class="language-plaintext highlighter-rouge">2**64-1</code>. Attempting to allocate larger arrays now directly reverts.
This effectively prevents such overflows from occurring.</p>

      </article>

      

      
        <!-- Check if any share-links are active -->





      

      <ul class="pager blog-pager">
        
        <li class="previous">
          <a href="/ewasm-portal/2020/03/26/fallback-receive-split/" data-toggle="tooltip" data-placement="top" title="Solidity 0.6.x features: fallback and receive functions">&larr; Previous Post</a>
        </li>
        
        
        <li class="next">
          <a href="/ewasm-portal/2020/04/06/solidity-0.6.5-release-announcement/" data-toggle="tooltip" data-placement="top" title="Solidity 0.6.5 Release Announcement">Next Post &rarr;</a>
        </li>
        
      </ul>

      
        <div class="disqus-comments">
          
        </div>
      
    </div>
  </div>
</div>


    <footer>
  <div class="container beautiful-jekyll-footer">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links"><li><a href="/ewasm-portal/feed.xml" title="RSS"><span class="fa-stack fa-lg" aria-hidden="true">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                </span>
                <span class="sr-only">RSS</span>
              </a>
            </li><li><a href="mailto:solidity@ethereum.org" title="Email me"><span class="fa-stack fa-lg" aria-hidden="true">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                </span>
                <span class="sr-only">Email me</span>
              </a>
            </li><li><a href="https://github.com/ewasm" title="GitHub"><span class="fa-stack fa-lg" aria-hidden="true">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                </span>
                <span class="sr-only">GitHub</span>
              </a>
            </li><li><a href="https://gitter.im/ethereum/ewasm" title="Gitter"><span class="fa-stack fa-lg" aria-hidden="true">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-comments fa-stack-1x fa-inverse"></i>
                </span>
                <span class="sr-only">Gitter</span>
              </a>
            </li><li><a href="https://twitter.com/ethereumWasm" title="Twitter"><span class="fa-stack fa-lg" aria-hidden="true">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                </span>
                <span class="sr-only">Twitter</span>
              </a>
            </li></ul>
      <p class="copyright text-muted">
        Ewasm Team
        &nbsp;&bull;&nbsp;
        2020

        
        &nbsp;&bull;&nbsp;
        <a href="https://ewasm.ethereum.org">ewasm.ethereum.org</a>
        

        &nbsp;&bull;&nbsp;
        <a href="/archive/">Blog Archive</a>

        
        
      </p>
        <!-- Please don't remove this, keep my open source work credited :) -->
        <p class="theme-by text-muted">
          Theme by
          <a href="http://deanattali.com/beautiful-jekyll/">beautiful-jekyll</a>
        </p>
      </div>
    </div>
  </div>
</footer>

  
    






  
    
    
      <script>
      	if (typeof jQuery == 'undefined') {
      	  document.write('<script src="/ewasm-portal/js/jquery-1.11.2.min.js"></scr' + 'ipt>');
      	}
      </script>
    
  
    
    
	<script src="/ewasm-portal/js/bootstrap.min.js"></script>
    
  
    
    
	<script src="/ewasm-portal/js/main.js"></script>
    
  



  
  </body>
</html>
